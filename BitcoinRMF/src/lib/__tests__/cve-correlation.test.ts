import { describe, it, expect } from 'vitest';
import { classifyCVEComponents, mapCVSSSeverityToLevel } from '../cve-correlation';
import { AffectedComponent } from '@/types';

// --- classifyCVEComponents ---

describe('classifyCVEComponents', () => {
  it('maps script-related keywords to SCRIPT_ENGINE', () => {
    const result = classifyCVEComponents(
      'Bitcoin Core allows remote attackers to bypass script validation via OP_CHECKMULTISIG'
    );
    expect(result).toContain(AffectedComponent.SCRIPT_ENGINE);
  });

  it('maps inscription/tapscript keywords to SCRIPT_ENGINE', () => {
    const result = classifyCVEComponents(
      'Inscription data bypass allows arbitrary data in tapscript witness'
    );
    expect(result).toContain(AffectedComponent.SCRIPT_ENGINE);
  });

  it('maps consensus keywords to CONSENSUS', () => {
    const result = classifyCVEComponents(
      'Block validation flaw could lead to chain split in consensus layer'
    );
    expect(result).toContain(AffectedComponent.CONSENSUS);
  });

  it('maps P2P network keywords to P2P_NETWORK', () => {
    const result = classifyCVEComponents(
      'Eclipse attack via addr message flooding in peer-to-peer layer'
    );
    expect(result).toContain(AffectedComponent.P2P_NETWORK);
  });

  it('maps wallet keywords to WALLET', () => {
    const result = classifyCVEComponents(
      'Private key leak in wallet key derivation path'
    );
    expect(result).toContain(AffectedComponent.WALLET);
  });

  it('maps mining keywords to MINING', () => {
    const result = classifyCVEComponents(
      'Selfish mining attack via block template manipulation'
    );
    expect(result).toContain(AffectedComponent.MINING);
  });

  it('maps crypto keywords to CRYPTO_STACK', () => {
    const result = classifyCVEComponents(
      'Vulnerability in secp256k1 ECDSA signature verification'
    );
    expect(result).toContain(AffectedComponent.CRYPTO_STACK);
  });

  it('maps DoS/Bitcoin Core keywords to FULL_NODE', () => {
    const result = classifyCVEComponents(
      'Bitcoin Core before 0.21 allows DoS via resource exhaustion'
    );
    expect(result).toContain(AffectedComponent.FULL_NODE);
  });

  it('maps SPV keywords to SPV_CLIENT', () => {
    const result = classifyCVEComponents(
      'Bloom filter privacy leak in SPV light client'
    );
    expect(result).toContain(AffectedComponent.SPV_CLIENT);
  });

  it('defaults to FULL_NODE when no patterns match', () => {
    const result = classifyCVEComponents(
      'Generic software issue with no Bitcoin-specific keywords'
    );
    expect(result).toEqual([AffectedComponent.FULL_NODE]);
  });

  it('returns multiple components for multi-component CVEs', () => {
    const result = classifyCVEComponents(
      'Bitcoin Core DoS via malformed script in consensus validation causing crash'
    );
    expect(result).toContain(AffectedComponent.SCRIPT_ENGINE);
    expect(result).toContain(AffectedComponent.CONSENSUS);
    expect(result).toContain(AffectedComponent.FULL_NODE);
    expect(result.length).toBeGreaterThanOrEqual(3);
  });

  it('does not duplicate components', () => {
    const result = classifyCVEComponents(
      'Script opcode OP_IF and script witness bypass'
    );
    const scriptCount = result.filter((c) => c === AffectedComponent.SCRIPT_ENGINE).length;
    expect(scriptCount).toBe(1);
  });
});

// --- mapCVSSSeverityToLevel ---

describe('mapCVSSSeverityToLevel', () => {
  it('maps critical to severity 5, exploitability 4', () => {
    expect(mapCVSSSeverityToLevel('critical')).toEqual({ severity: 5, exploitability: 4 });
  });

  it('maps high to severity 4, exploitability 3', () => {
    expect(mapCVSSSeverityToLevel('high')).toEqual({ severity: 4, exploitability: 3 });
  });

  it('maps medium to severity 3, exploitability 2', () => {
    expect(mapCVSSSeverityToLevel('medium')).toEqual({ severity: 3, exploitability: 2 });
  });

  it('maps low to severity 2, exploitability 1', () => {
    expect(mapCVSSSeverityToLevel('low')).toEqual({ severity: 2, exploitability: 1 });
  });

  it('maps unknown to severity 2, exploitability 1', () => {
    expect(mapCVSSSeverityToLevel('unknown')).toEqual({ severity: 2, exploitability: 1 });
  });

  it('is case-insensitive', () => {
    expect(mapCVSSSeverityToLevel('CRITICAL')).toEqual({ severity: 5, exploitability: 4 });
    expect(mapCVSSSeverityToLevel('High')).toEqual({ severity: 4, exploitability: 3 });
  });
});
